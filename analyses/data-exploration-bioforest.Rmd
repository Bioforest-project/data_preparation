---
title: "Data preparation for Bioforest project"
author: "Camille Piponiot and Mithila Unkule"
date: "2024-07-08"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(data.table)
library(BIOMASS)
library(ggplot2)
library(tidyverse)
```

## Load all datasets

```{r load-data}

# make sure all datasets are inside the folder raw-data and are names as output_data_sitename with no spaces

# trying the same chunk of code as before, using dplyr
# compare the 2 chunks and observed a few second of difference: dplyr is slower 

harmonized_files <- list.files(path = "data/raw-data/", full.names = TRUE, pattern = "output_data")

data <- 
  lapply(harmonized_files, read.csv) %>% 
  rbindlist(use.names = TRUE, fill = TRUE) %>% #why are there 2 columns lifestatus and lifestatus1 ?
  filter(LifeStatus %in% c(TRUE, NA, "Normal", "Recruit")) %>%
  filter(Diameter >= MinDBH) %>%
  filter(!(LifeForm %in% c("Palm", "Tree fan", "Death", "Vine"))) %>%  # subsetting to remove life forms other
  select(Site, Year, Plot, PlotArea, MinDBH, ScientificName, VernName, Family, Genus, Species, Diameter,IdTree,IdStem) %>%
  mutate(diameter_class =  case_when(Diameter <= 10 ~ "0", 
                               Diameter > 10 & Diameter <= 20 ~ "1",
                               Diameter > 20 & Diameter <= 30 ~ "2",
                               Diameter > 30 & Diameter <= 40 ~ "3",
                               Diameter > 40 & Diameter <= 50 ~ "4",
                               Diameter > 50 & Diameter <= 60 ~ "5",
                               Diameter > 60 & Diameter <= 70 ~ "6",
                               Diameter > 70 & Diameter <= 80 ~ "7",
                               Diameter > 80 & Diameter <= 90 ~ "8",
                               Diameter > 90 & Diameter <= 100 ~ "9",
                               Diameter > 100 & Diameter <= 110 ~ "10",
                               Diameter > 110 & Diameter <= 120 ~ "11",
                               Diameter > 120 & Diameter <= 130 ~ "12",
                               Diameter > 130 & Diameter <= 140 ~ "13",
                               Diameter > 140 & Diameter <= 150 ~ "14",
                               Diameter > 150 & Diameter <= 160 ~ "15",
                               Diameter > 160 & Diameter <= 170 ~ "16",
                               Diameter > 170 & Diameter <= 180 ~ "17",
                               Diameter > 180 & Diameter <= 190 ~ "18",
                               Diameter > 190 & Diameter <= 200 ~ "19",
                               Diameter > 200 ~ "20")) %>%
  add_column(Treatment = NA) %>% # to be filled with treatment of different plots
  add_column(Rel_year = NA) # to be filled with number of years after treatment

  #making modifications for each site as required
  
  # Misiones

      
    if("Misiones" %in% data$Site){
    data_temp_misiones <- data[data$Site == "Misiones",] %>%
    filter(!(Family %in% c("muerto", "ND"))) %>% 
    #select(Site, Year, Plot, PlotArea, Family, ScientificName, Diameter) %>% 
    mutate(Family = gsub("No determinado", "undet", Family)) %>% 
    mutate(ScientificName = gsub("No Determinado", "undet undet", ScientificName)) %>% 
    separate(ScientificName, c("Genus", "Species"), remove = FALSE) %>% 
    mutate(Species = ifelse(is.na(Species), "undet", Species)) %>%  
    mutate(Year = ifelse(Year == 2018, 2019, Year))  %>%
    mutate(Treatment = ifelse(Plot %in% c(4,12,13,14), "control", "logged")) %>% 
    mutate(Rel_year = Year - 1999)   
    data <- rbind(data_temp_misiones, data[data$Site != "Misiones",]) }


  # paracou
  # remove palms
  ##### do we need to remove these palms from other french guiana sites too?
  #####what if we remove all rows with the following genus?
  if("Paracou" %in% data$Site){
  data_temp_paracou <- data[data$Site == "Paracou",] %>%
  filter(!(Genus %in% c("Oenocarpus", "Euterpe", "Astrocaryum") & VernName =="murumuru")) %>%
  filter(!(as.numeric(Plot) == 16)) %>%
  filter(!((Year %in% c(1996, 1998, 2000, 2002)))) %>% # Paracou: remove partial census years
  filter(!(Year == 2010 & Plot == 15)) %>% ## one fourth of plot 15 wasn't censused in 2010
  mutate(Genus = gsub("Indet.", "", Genus)) %>% 
  mutate(Species = gsub("Indet.", "undet", Species)) %>% 
  mutate(Treatment = ifelse(Plot %in% c(1,6,11,13:15), "control", "logged")) %>% 
  mutate(Rel_year = Year - 1986) %>% 
  filter(paste(Plot, Year) != "15 2010")
  data <- rbind(data_temp_paracou, data[data$Site != "Paracou",]) }  

  #moju
   if("Moju" %in% data$Site){
  data_temp_moju <- data[data$Site == "Moju",] %>%
  separate(VernName, c("VernName", "GenusSpecies"), sep = "\\[") %>% 
  mutate(GenusSpecies = gsub("]", "", GenusSpecies)) %>% 
  separate(GenusSpecies, c("Genus", "Species")) %>% 
  mutate(Species = ifelse(Genus == "", 'undet', Species)) %>% 
  mutate(Genus = ifelse(Genus == "", 'undet', Genus)) %>%
  mutate(Rel_year = Year - 1997)
  data <- rbind(data_temp_moju, data[data$Site != "Moju",]) }  

  #malinau
   if("Malinau" %in% data$Site){
  data_temp_malinau <- data[data$Site == "Malinau",] %>%
  separate(ScientificName, c("Genus", "Species"), sep = " ", remove = FALSE) %>% 
  mutate(Species = ifelse(Genus == "", 'undet', Species)) %>% 
  mutate(Genus = ifelse(Genus == "", 'undet', Genus)) %>%
  mutate(Rel_year = Year - 1999) 
  data <- rbind(data_temp_malinau, data[data$Site != "Malinau",]) }  

    #kibale
   if("Kibale" %in% data$Site){
  data_temp_kibale <- data[data$Site == "Kibale",] %>%
  separate(ScientificName, c("Genus", "Species"), sep = " ", remove = FALSE) %>% 
  mutate(Species = ifelse(Genus == "", 'undet', Species)) %>% 
  mutate(Genus = ifelse(Genus == "", 'undet', Genus)) %>%
  mutate(Rel_year = Year - 1969) 
  data <- rbind(data_temp_kibale, data[data$Site != "Kibale",]) }


head(data)
summary(data)
  
print(data)

#write.csv(data, "C:/Users/CESAB/Documents/Work/BioForest/DataPrep/data/raw-data/output_data_all.csv")



```



## Visualization

Checking for any outliers in the data entry in variables such as year, diameter measurements 

```{r plot}

  ggplot(data[data$Site != "Tene",], aes(x = Year, y = Diameter, col = factor(Species))) +
  #ggplot(data, aes(x = Year, y = Diameter, col = factor(Species))) +
  geom_point() + 
  #geom_line() + 
  facet_wrap(~Site) +
  theme(legend.position = "none")


```




Creating a summary of the dataset per site to check if there are any abnormalities

```{r}

site_info <- data %>%
                 group_by(Site) %>%
                 summarise(nb_plots= n_distinct(Plot), nb_id = n_distinct(ScientificName), nb_genus = n_distinct(Genus), nb_species = n_distinct(Species), nb_trees = n_distinct(IdTree), dbh_cass = n_distinct(diameter_class))

print(site_info)


```



Questions and required corrections:
- Tene: Is it normal to have such large trees in Tene?
- Misiones: Need to correct the 2018 data
- Only vernacular names for ONF sites in French Guiana (manare and bafog)
- Should we split scientific name into genus and species for all? Need to check species ID from PIs


## calculations and aggregations for WG1

```{r}

#data %>%
#  group_by(Site, Year, Plot, PlotArea, Family, Genus, Species, diameter_class) %>% 
#  summarise(abundance = n()/unique(PlotArea),
#            ba = sum((Diameter/2)^2*pi)/10^4/unique(PlotArea)) %>%
#  ungroup() %>%
#  group_by(Site, Plot, Year) %>% 
#  summarise(ba = sum(ba)) %>% 
#  filter(Rel_year < 6) %>% 
#  group_by(Plot, post = as.numeric(Rel_year > 0)) %>% 
#  summarise(ba = sum(ba), ba_mean = mean(ba), ba_min = min(ba)) %>% 
#  gather(metric, value, -Plot, -post) %>% 
#  mutate(metric = paste0(metric, "_", post)) %>% 
#  select(-post) %>% 
#  pivot_wider(names_from = metric, values_from = value) %>% 
#  mutate(delta_ba = ba_mean_0 - ba_min_1) %>% 
#  mutate(delta_ba = ifelse(delta_ba < 1, 0, delta_ba)) %>% 
#  mutate(delta_ba_pct = delta_ba/ba_mean_0*100) %>% 
#  rename(ba_pre = ba_mean_0, ba_post = ba_min_1) %>% 
#  select(plot, ba_pre, ba_post, delta_ba, delta_ba_pct)

#print(summary(data))


```


```{r-plot}

data %>% 
  group_by(Site, Year, Rel_year, Delta_ba, Plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = paste(site, plot))) +
  geom_line() +
  geom_point() +
  theme_bw() +
  geom_vline(xintercept = 0, linetype = "dashed") +  
  xlab("") + 
  ylab(expression("Basal area of tree " >=10 ~"cm dbh ["~m^{2}~ha^{-~1}~"]")) +
  scale_color_viridis_c(expression(Delta[BA]))



data %>% 
  group_by(Site, Year, Delta_ba, Plot) %>% 
  summarise(ba = sum(ba)) %>% 
  ggplot(aes(rel_year, ba, col = delta_ba, group = paste(site, plot)))

```

## Taxonomic correction

## DBH correction

### Add missing measurements

If a tree is not measured in a census and then reappears in a later census, we can consider that it was just missed. In this case, a possible correction is to replace the missed measurements by interpolating with the last DBH before it was missed and the next one after.

```{r interpolate-missing-trees}
# list all possible years of census for every tree
dfAll = data[, .(Year = seq(min(Year), max(Year))), .(Site, Plot, IdTree)] |> 
  # only keep years when the plot was really censused
  merge(unique(data[, c("Site", "Plot", "PlotArea", "Year")]), 
        by = c("Site", "Plot", "Year")) |> 
  # add DBH measurements
  merge(data[, c("IdTree", "Year", "Diameter")], by = c("IdTree", "Year"), all = TRUE)
# spot missing measurements
IdMissing = dfAll[is.na(Diameter), unique(IdTree)]
# replace missing measurements 
dfAll[, DiameterCor := Diameter]
dfAll[IdTree %in% IdMissing, 
      DiameterCor := approx(Year, Diameter, Year)$y, 
      .(Site, Plot, PlotArea, IdTree)]
```

The following figure shows a sample of 12 trees corrected for missing DBH. The added DBH values are shown in red.

```{r, fig.height = 8, fig.width = 10}
dfAll[IdTree %in% sample(IdMissing, 12)] |> 
  ggplot(aes(x=Year)) + 
  geom_point(aes(y=DiameterCor), col = 2) +
  geom_point(aes(y=Diameter)) + 
  facet_wrap(~IdTree, scales = "free")
```

```{r add-missing}
data = merge(
  data[, -"PlotArea"], dfAll[, -"Diameter"], 
  by = c("Site", "Plot", "IdTree", "Year"), all = TRUE)
```

It is important to note that this correction may introduce some bias, as it will not be able to detect missed trees in the first and last censuses of a plot.

## Functional traits

```{r get-ft-value}
# get wood density 
data[, wd := BIOMASS::getWoodDensity(Genus, Species, stand = Plot)$meanWD]
```

```{r plot-ft}
# plot distribution of wood density values
ggplot(data, aes(x=wd)) + 
  geom_histogram() +
  labs(x = "Wood density (g.cm-3)") +
  #facet_grid(. ~ Site) +
  theme_classic()
```

## Diversity indices

## DBH classes

We define size classes in intervals of 10 cm DBH: Class 1 will include trees with a DBH between 10 and 20 cm, class 2-trees between DBH of 21-30 cm, class 3- 31-40 cm. This will allow in calculation of variables for each size class, which can later be grouped if required.

For WP3: We do not allow large trees ($!=$) to return to the "small" size class, which occurs when the DBH of trees oscillates around 20 cm DBH.

```{r dbh_class}
data <- data %>%
        

print(head(data))

```

## DBH classes

We define two size classes: small trees with a DBH between 10 and 20 cm, and trees with a DBH $\geq$ 20 cm. We do not allow large trees to return to the "small" size class, which occurs when the DBH of trees oscillates around 20 cm DBH.

```{r tree-size-class}
# small (10-20 cm DBH) and large (>= 20 cm DBH) trees
data[, class := 1 + (DiameterCor >= 20)]

# avoid trees switching between classes: once a tree is 'large' it cannot go back to 'small'
setorder(data, Year)
data[IdTree %in% data[class==2, unique(IdTree)], 
     YL := min(Year[class==2]), .(IdTree)] # YL: first year that a tree becomes large (defined by tree)
data[!is.na(YL) & Year > YL, class := 2] # after YL: a tree cannot become small again
```

```{r check-corr-class, fig.height= 6, fig.width=10}
# select a sample of 6 trees that have corrected size classes
CorrClass = sample(data[class == 2 & DiameterCor < 20, unique(IdTree)], 12)
subset(data, IdTree %in% CorrClass) |> 
  ggplot(aes(x = Year, y = DiameterCor, col = factor(class))) +
  geom_hline(yintercept = 20, lty=2) +
  geom_point() + 
  geom_line() + 
  facet_wrap(~IdTree, scales = "free") 
```

# Tree-by-tree stocks and fluxes

```{r census-interval}
setorder(data, Site, Plot, Year)
# get info on census intervals (by plot) to be used in flux calculation
dfYear = data[, .(Year = sort(unique(Year)),
                  firstCensus = min(Year),
                  NextCensus = c(sort(unique(Year))[-1], NA), 
                  dT = c(NA, diff(sort(unique(Year))))), # census interval between this census and the previous one
              .(Site, Plot)]
data = merge(data, dfYear, by = c("Site", "Plot", "Year"))
```

We divide trees into recruits (year of first measurement of a tree), other live trees, and dead trees (census when trees are recorded as dead: they are given a DBH = 0 cm).

```{r tree-status}
# live trees
data[, status := "A"]

# trees on year of recruitment (or when changing classes): status = "R" for
# recruited tree. First year of measurement by tree and size class:
data[, recrYear := min(Year), .(IdTree, class)] 
data[Year == recrYear & Year != firstCensus, status := "R"]

# mortality: add one measurement with DBH = 0 after tree death
data[, mortYear := max(NextCensus), .(IdTree)]
dataMort = data[mortYear == NextCensus & !is.na(mortYear)]
dataMort[, `:=`(
  Year = NextCensus,
  status = "M",
  DiameterCor = 0,
  dT = NextCensus - Year
)]
data = rbind(data, dataMort)
```

We then calculate basal area per tree, and the tree-level change in basal area between two censuses.

```{r ba-stocks-and-fluxes}
setorder(data, Year)
# basal area 
data[, ba := pi*(DiameterCor/200)**2]
# change in basal area (m2/yr) by tree
data[, dba := c(NA, diff(ba)/diff(Year)), .(IdTree)]
# for recruits: their basal area change is their basal area divided by the
# census interval before their recruitment
data[status == "R", dba := (ba-0)/dT]
```

# Plot-level variables

```{r data-aggregation}
dataPlot = 
  rbind(
    # basal area stocks and fluxes
    data[, .(
      stock = sum(ba)/unique(PlotArea), 
      mortality = sum(dba[status == "M"])/unique(PlotArea), 
      recruitment = sum(dba[status == "R"])/unique(PlotArea), 
      growth = sum(dba[status == "A"])/unique(PlotArea), 
      meas = "ba"), 
      .(Site, Plot, Year, class)],
    # mean wood density (weighted by ba) associated with stocks and fluxes
    data[, .(
      stock = weighted.mean(wd, ba), 
      mortality = weighted.mean(wd[status == "M"], abs(dba[status == "M"])), 
      recruitment = weighted.mean(wd[status == "R"], dba[status == "R"]), 
      growth = weighted.mean(wd[status == "A"], dba[status == "A"]), 
      meas = "wd_ba"
    ), .(Site, Plot, Year, class)],
    # 'stocks' and fluxes of tree abundance
    data[, .(
      stock = sum(status %in% c("R", "A"))/unique(PlotArea), 
      mortality = sum(status == "M")/unique(dT)/unique(PlotArea), 
      recruitment = sum(status == "R")/unique(dT)/unique(PlotArea), 
      growth = NA, 
      meas = "n"
    ), .(Site, Plot, Year, class)],
    # mean wood density associated with stocks and fluxes
    data[, .(
      stock = mean(wd), 
      mortality = mean(wd[status == "M"]), 
      recruitment = mean(wd[status == "R"]), 
      growth = NA, 
      meas = "wd_n"
    ), .(Site, Plot, Year, class)]
  )

dataPlot = melt(dataPlot, measure.vars = c("stock", "mortality", "recruitment", "growth"))

# remove fluxes on the last census of measurement
dataPlot[variable != "stock" & Year == max(Year), value := NA, .(Site)]
```

## Add metadata

```{r}
# Paracou treatments
PlotInfo = data.frame(
  Site = "Paracou",
  Plot = 1:15, 
  treat = "logged"
)
# Paracou control plots
PlotInfo$treat[PlotInfo$Plot %in% c(1, 6, 11, 13:15)] = "control"
dataPlot = merge(PlotInfo, dataPlot)
```

```{r save-results}
save(dataPlot, file = "data/derived-data/dataPlot_WG3.rda")
write.csv(dataPlot, file = "data/derived-data/dataPlot_WG3.csv")
```

## Visualisation

```{r data-vis, fig.height=10, fig.width = 6}
subset(dataPlot, meas == "wd_ba") |>  
  subset(!(variable=="mortality" & Year < 1990)) |> # remove logging years with high mortality
  subset(!(variable=="recruitment" & class==2)) |> # remove recruitment of trees > 20 cm DBH
  ggplot(aes(x=Year, y = value, group = paste(Plot, class), col=factor(class)))+
  geom_point() + geom_line() +
  facet_grid(variable ~ Site, scales = "free")
```
